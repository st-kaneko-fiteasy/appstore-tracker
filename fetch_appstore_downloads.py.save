import jwt
import requests
import gzip
from datetime import datetime, timedelta
import pandas as pd
import gspread
from google.oauth2.service_account import Credentials
import os
import io

class AppStoreDownloadTracker:
    def __init__(self, key_id, issuer_id, private_key_path, 
                 google_creds_path, sheet_name):
        self.key_id = key_id
        self.issuer_id = issuer_id
        self.private_key_path = private_key_path
        self.google_creds_path = google_creds_path
        self.sheet_name = sheet_name
        
    def generate_token(self):
        """App Store Connect APIのJWTトークンを生成"""
        with open(self.private_key_path, 'r') as f:
            private_key = f.read()
        
        token = jwt.encode(
            {
                'iss': self.issuer_id,
                'exp': datetime.utcnow() + timedelta(minutes=20),
                'aud': 'appstoreconnect-v1'
            },
            private_key,
            algorithm='ES256',
            headers={'kid': self.key_id}
        )
        return token
    
    def get_sales_report(self, vendor_number, report_date):
        """App Store Connectからダウンロード数を取得"""
        token = self.generate_token()
        
        url = 'https://api.appstoreconnect.apple.com/v1/salesReports'
        headers = {
            'Authorization': f'Bearer {token}',
            'Accept': 'application/a-gzip'
        }
        
        params = {
            'filter[f
